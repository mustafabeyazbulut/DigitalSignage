@model DigitalSignage.Models.Layout

@{
    var locale = ViewBag.CurrentLocale as string ?? "en";
    var lang = ViewBag.Lang as DigitalSignage.Services.ILanguageService;
    string T(string key) => lang?.Get(locale, key) ?? key;
    ViewData["Title"] = T("layout.detailsTitle");
}

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1>@Model.LayoutName</h1>
        </div>
        <div class="col-md-4 text-end">
            <a asp-action="Edit" asp-route-id="@Model.LayoutID" class="btn btn-warning">@T("common.edit")</a>
            <a asp-action="Delete" asp-route-id="@Model.LayoutID" class="btn btn-danger">@T("common.delete")</a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-5">
            <div class="card">
                <div class="card-header">
                    <h5>@T("layout.layoutInfo")</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">@T("layout.totalSections")</dt>
                        <dd class="col-sm-8">@Model.TotalSections</dd>

                        <dt class="col-sm-4">@T("layout.rows")</dt>
                        <dd class="col-sm-8">@Model.RowCount</dd>

                        <dt class="col-sm-4">@T("company.description")</dt>
                        <dd class="col-sm-8">@(Model.Description ?? T("common.noDescription"))</dd>

                        <dt class="col-sm-4">@T("common.status")</dt>
                        <dd class="col-sm-8">
                            <span class="badge @(Model.IsActive ? "bg-success" : "bg-danger")">
                                @(Model.IsActive ? T("common.active") : T("common.inactive"))
                            </span>
                        </dd>

                        <dt class="col-sm-4">@T("common.createdDate")</dt>
                        <dd class="col-sm-8">@Model.CreatedDate.ToString("yyyy-MM-dd HH:mm")</dd>
                    </dl>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card">
                <div class="card-header">
                    <h5>@T("layout.preview")</h5>
                </div>
                <div class="card-body">
                    @{
                        var definition = Model.LayoutDefinition ?? "{\"rows\":[{\"height\":100,\"columns\":[{\"width\":100}]}]}";
                        try
                        {
                            var def = System.Text.Json.JsonSerializer.Deserialize<DigitalSignage.Models.LayoutDefinitionModel>(definition,
                                new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                            if (def?.Rows != null)
                            {
                                <div style="display:flex;flex-direction:column;gap:6px;min-height:400px;border:2px solid #dee2e6;padding:6px;border-radius:8px;background:#f8f9fa;">
                                    @RenderPreviewRows(def.Rows, "")
                                </div>
                            }
                        }
                        catch
                        {
                            <div class="alert alert-warning">@T("layout.invalidDefinition")</div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <button type="button" class="btn btn-secondary" data-smart-back="@ViewBag.BreadcrumbBackUrl">@T("common.backToList")</button>
    </div>
</div>

@functions {
    IHtmlContent RenderPreviewRows(List<DigitalSignage.Models.LayoutRowDefinition> rows, string parentPos)
    {
        var sb = new System.Text.StringBuilder();
        foreach (var row in rows)
        {
            var colTemplate = string.Join(" ", row.Columns?.Select(c => c.Width + "fr") ?? Array.Empty<string>());
            var rowIdx = rows.IndexOf(row);
            sb.Append($"<div style=\"display:grid;grid-template-columns:{colTemplate};gap:6px;flex:{row.Height};\">");
            if (row.Columns != null)
            {
                var colIdx = 0;
                foreach (var col in row.Columns)
                {
                    var pos = string.IsNullOrEmpty(parentPos) ? $"R{rowIdx + 1}C{colIdx + 1}" : $"{parentPos}.R{rowIdx + 1}C{colIdx + 1}";
                    if (col.Rows != null && col.Rows.Count > 0)
                    {
                        sb.Append("<div style=\"display:flex;flex-direction:column;gap:4px;border:2px dashed #ff9800;border-radius:6px;padding:4px;background:rgba(255,152,0,0.05);\">");
                        sb.Append(RenderPreviewRowsString(col.Rows, pos));
                        sb.Append("</div>");
                    }
                    else
                    {
                        sb.Append($"<div style=\"background:linear-gradient(135deg,#e3f2fd,#bbdefb);border:1px solid #90caf9;border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px;\">");
                        sb.Append($"<strong class=\"text-primary\">{pos}</strong>");
                        sb.Append($"<small class=\"text-muted\">{col.Width}% x {row.Height}%</small>");
                        sb.Append("</div>");
                    }
                    colIdx++;
                }
            }
            sb.Append("</div>");
        }
        return new HtmlString(sb.ToString());
    }

    string RenderPreviewRowsString(List<DigitalSignage.Models.LayoutRowDefinition> rows, string parentPos)
    {
        var sb = new System.Text.StringBuilder();
        foreach (var row in rows)
        {
            var colTemplate = string.Join(" ", row.Columns?.Select(c => c.Width + "fr") ?? Array.Empty<string>());
            var rowIdx = rows.IndexOf(row);
            sb.Append($"<div style=\"display:grid;grid-template-columns:{colTemplate};gap:4px;flex:{row.Height};\">");
            if (row.Columns != null)
            {
                var colIdx = 0;
                foreach (var col in row.Columns)
                {
                    var pos = $"{parentPos}.R{rowIdx + 1}C{colIdx + 1}";
                    if (col.Rows != null && col.Rows.Count > 0)
                    {
                        sb.Append("<div style=\"display:flex;flex-direction:column;gap:3px;border:2px dashed #ff9800;border-radius:4px;padding:3px;background:rgba(255,152,0,0.05);\">");
                        sb.Append(RenderPreviewRowsString(col.Rows, pos));
                        sb.Append("</div>");
                    }
                    else
                    {
                        sb.Append($"<div style=\"background:linear-gradient(135deg,#e3f2fd,#bbdefb);border:1px solid #90caf9;border-radius:4px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:6px;font-size:0.75rem;\">");
                        sb.Append($"<strong class=\"text-primary\">{pos}</strong>");
                        sb.Append("</div>");
                    }
                    colIdx++;
                }
            }
            sb.Append("</div>");
        }
        return sb.ToString();
    }
}
