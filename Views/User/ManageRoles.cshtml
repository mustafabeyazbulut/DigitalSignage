@model DigitalSignage.ViewModels.UserRoleManagementViewModel
@{
    var locale = ViewBag.CurrentLocale as string ?? "en";
    var lang = ViewBag.Lang as DigitalSignage.Services.ILanguageService;
    string T(string key) => lang?.Get(locale, key) ?? key;
    ViewData["Title"] = $"{T("user.manageRoles")} - {Model.User.Email}";
    var isTargetUserSystemAdmin = ViewBag.IsTargetUserSystemAdmin as bool? ?? false;
}

<div class="container-fluid py-4">
  

    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="mb-1">@T("user.manageRoles")</h3>
            <p class="text-muted mb-0">
                <i class="fas fa-user me-1"></i>
                @Model.User.FirstName @Model.User.LastName <span class="text-secondary">(@Model.User.Email)</span>
            </p>
        </div>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> @T("common.back")
        </a>
    </div>

    @if (isTargetUserSystemAdmin)
    {
        <div class="alert alert-light border-start border-primary border-4 mb-4" role="alert">
            <div class="d-flex align-items-center">
                <i class="fas fa-info-circle text-primary me-3" style="font-size: 1.5rem;"></i>
                <div>
                    <strong>@T("user.systemAdminDoesNotNeedRoles")</strong>
                </div>
            </div>
        </div>
    }

    <!-- Company Roles Section -->
    <div class="mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom py-3">
                <h5 class="mb-0 fw-semibold">
                    <i class="fas fa-building me-2 text-primary"></i>
                    @T("role.companyRolesTitle")
                </h5>
            </div>
            <div class="card-body p-0">
                <!-- Existing Company Roles -->
                @if (Model.CompanyRoles.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0">@T("common.company")</th>
                                    <th class="border-0">@T("common.role")</th>
                                    <th class="border-0">@T("common.status")</th>
                                    <th class="border-0 text-end">@T("common.actions")</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var role in Model.CompanyRoles)
                                {
                                    <tr>
                                        <td class="align-middle">
                                            <strong>@role.CompanyName</strong>
                                        </td>
                                        <td class="align-middle">
                                            <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2">@role.Role</span>
                                        </td>
                                        <td class="align-middle">
                                            @if (role.IsActive)
                                            {
                                                <span class="badge bg-success bg-opacity-10 text-success px-3 py-2">
                                                    <i class="fas fa-check-circle me-1"></i>@T("common.active")
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary bg-opacity-10 text-secondary px-3 py-2">
                                                    <i class="fas fa-times-circle me-1"></i>@T("common.inactive")
                                                </span>
                                            }
                                        </td>
                                        <td class="align-middle text-end">
                                            <form asp-action="RemoveCompanyRole" method="post" class="d-inline" onsubmit="return confirm('@T("common.confirmRemove")');">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="userId" value="@Model.User.UserID" />
                                                <input type="hidden" name="companyId" value="@role.CompanyID" />
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="fas fa-trash-alt me-1"></i>@T("common.remove")
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="p-4 text-center text-muted">
                        <i class="fas fa-info-circle me-2"></i>
                        @T("role.noCompanyRoles")
                    </div>
                }

                @if (!isTargetUserSystemAdmin)
                {
                    <!-- Add Company Role Form -->
                    <div class="p-4 bg-light border-top">
                        <h6 class="mb-3 fw-semibold">@T("role.assignCompanyRole")</h6>
                        <form asp-action="AssignCompanyRole" method="post" class="row g-3">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="UserID" value="@Model.User.UserID" />

                            <div class="col-md-5">
                                <label class="form-label small text-muted mb-1">@T("common.company")</label>
                                <select name="CompanyID" class="form-select" required>
                                    <option value="">@T("common.selectCompany")</option>
                                    @foreach (var company in Model.AvailableCompanies)
                                    {
                                        <option value="@company.CompanyID">@company.CompanyName</option>
                                    }
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label small text-muted mb-1">@T("common.role")</label>
                                <select name="Role" class="form-select" required>
                                    <option value="">@T("role.selectRole")</option>
                                    <option value="CompanyAdmin">@T("role.companyAdmin")</option>
                                    <option value="Viewer">@T("role.viewer")</option>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label small text-muted mb-1">&nbsp;</label>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-plus me-1"></i>@T("common.assign")
                                </button>
                            </div>
                        </form>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Department Roles Section -->
    <div class="mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-bottom py-3">
                <h5 class="mb-0 fw-semibold">
                    <i class="fas fa-sitemap me-2 text-success"></i>
                    @T("role.departmentRolesTitle")
                </h5>
            </div>
            <div class="card-body p-0">
                <!-- Existing Department Roles -->
                @if (Model.DepartmentRoles.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="border-0">@T("common.company")</th>
                                    <th class="border-0">@T("common.department")</th>
                                    <th class="border-0">@T("common.role")</th>
                                    <th class="border-0">@T("common.status")</th>
                                    <th class="border-0 text-end">@T("common.actions")</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var role in Model.DepartmentRoles)
                                {
                                    <tr>
                                        <td class="align-middle text-muted small">@role.CompanyName</td>
                                        <td class="align-middle">
                                            <strong>@role.DepartmentName</strong>
                                        </td>
                                        <td class="align-middle">
                                            <span class="badge bg-success bg-opacity-10 text-success px-3 py-2">@role.Role</span>
                                        </td>
                                        <td class="align-middle">
                                            @if (role.IsActive)
                                            {
                                                <span class="badge bg-success bg-opacity-10 text-success px-3 py-2">
                                                    <i class="fas fa-check-circle me-1"></i>@T("common.active")
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary bg-opacity-10 text-secondary px-3 py-2">
                                                    <i class="fas fa-times-circle me-1"></i>@T("common.inactive")
                                                </span>
                                            }
                                        </td>
                                        <td class="align-middle text-end">
                                            <form asp-action="RemoveDepartmentRole" method="post" class="d-inline" onsubmit="return confirm('@T("common.confirmRemove")');">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="userId" value="@Model.User.UserID" />
                                                <input type="hidden" name="departmentId" value="@role.DepartmentID" />
                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                    <i class="fas fa-trash-alt me-1"></i>@T("common.remove")
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="p-4 text-center text-muted">
                        <i class="fas fa-info-circle me-2"></i>
                        @T("role.noDepartmentRoles")
                    </div>
                }

                @if (!isTargetUserSystemAdmin)
                {
                    <!-- Add Department Role Form -->
                    <div class="p-4 bg-light border-top">
                        <h6 class="mb-3 fw-semibold">@T("role.assignDepartmentRole")</h6>
                        <form asp-action="AssignDepartmentRole" method="post" class="row g-3" id="departmentRoleForm">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="UserID" value="@Model.User.UserID" />

                            <div class="col-md-4">
                                <label class="form-label small text-muted mb-1">@T("common.company")</label>
                                <select id="companySelect" class="form-select" required>
                                    <option value="">@T("common.selectCompany")</option>
                                    @foreach (var company in Model.AvailableCompanies)
                                    {
                                        <option value="@company.CompanyID">@company.CompanyName</option>
                                    }
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label small text-muted mb-1">@T("common.department")</label>
                                <select name="DepartmentID" id="departmentSelect" class="form-select" required disabled>
                                    <option value="">@T("common.selectDepartment")</option>
                                </select>
                            </div>

                            <div class="col-md-2">
                                <label class="form-label small text-muted mb-1">@T("common.role")</label>
                                <select name="Role" class="form-select" required>
                                    <option value="">@T("role.selectRole")</option>
                                    <option value="DepartmentManager">@T("role.departmentManager")</option>
                                    <option value="Editor">@T("role.editor")</option>
                                    <option value="Viewer">@T("role.viewer")</option>
                                </select>
                            </div>

                            <div class="col-md-2">
                                <label class="form-label small text-muted mb-1">&nbsp;</label>
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-plus me-1"></i>@T("common.assign")
                                </button>
                            </div>
                        </form>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // AJAX: Load departments when company is selected
        document.addEventListener('DOMContentLoaded', function() {
            const companySelect = document.getElementById('companySelect');
            const departmentSelect = document.getElementById('departmentSelect');

            if (!companySelect || !departmentSelect) return;

            companySelect.addEventListener('change', function() {
                const companyId = this.value;

                // Clear and disable department dropdown
                departmentSelect.innerHTML = '<option value="">@T("common.selectDepartment")</option>';
                departmentSelect.disabled = true;

                if (!companyId) return;

                // Show loading state
                departmentSelect.innerHTML = '<option value="">@T("common.loading")...</option>';

                // Fetch departments via AJAX
                fetch(`/User/GetCompanyDepartments?companyId=${companyId}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        departmentSelect.innerHTML = '<option value="">@T("common.selectDepartment")</option>';
                        data.forEach(dept => {
                            const option = document.createElement('option');
                            option.value = dept.id;
                            option.textContent = dept.name;
                            departmentSelect.appendChild(option);
                        });
                        departmentSelect.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error loading departments:', error);
                        departmentSelect.innerHTML = '<option value="">@T("error.loadFailed")</option>';
                        alert('@T("error.failedToLoadDepartments")');
                    });
            });
        });
    </script>
}
